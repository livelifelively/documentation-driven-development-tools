# T32: Define Section Content Schemas

## 1 Meta & Governance

### 1.2 Status

- **Current State:** ‚è≥ In Progress
- **Priority:** üü• High
- **Progress:** 25%
- **Planning Estimate:** 25
- **Est. Variance (pts):** +12
- **Created:** 2025-08-03 06:13
- **Implementation Started:** 2025-08-04 17:55
- **Completed:**
- **Last Updated:** 2025-08-04 17:55

### 1.3 Priority Drivers

- [TEC-Prod_Stability_Blocker](../ddd-2.md#tec-prod_stability_blocker)
- [TEC-Dev_Productivity_Enhancement](../ddd-2.md#tec-dev_productivity_enhancement)

---

## 2 Business & Scope

### 2.1 Overview

- **Core Function**: This task is to create the canonical Zod schemas that define the expected content structure for each section within a `*.plan.md` or `*.task.md` document.
- **Key Capability**: It will produce one or more `*.ts` files that export Zod schemas for validating the parsed content of markdown sections (e.g., ensuring a "Status" section contains the correct bullet points).
- **Business Value**: Enables automated validation of documentation content, guaranteeing that all documents are structurally correct and can be reliably parsed by tools and LLMs. This prevents runtime errors in downstream tooling.

### 2.4 Definition of Done

| ID    | Criterion                                                                                                                      |
| :---- | :----------------------------------------------------------------------------------------------------------------------------- |
| DoD-1 | A validation library is available that can check the content of documentation files.                                           |
| DoD-2 | The library correctly identifies when a document's "Status" or "Priority" section has missing or malformed information.        |
| DoD-3 | The library can validate the structure of all tables, such as "Dependencies", ensuring they have the right columns.            |
| DoD-4 | The library successfully flags documents that contain structural errors and confirms that valid documents pass without errors. |
| DoD-5 | The validation logic for each of the 8 documentation families is organized separately for maintainability.                     |
| DoD-6 | The validation schemas are dynamically composed based on the `applicability` rules in the `ddd-schema-json` files.             |

---

## 3 Planning & Decomposition

### 3.3 Dependencies

| ID  | Dependency On                                                                   | Type     | Status  | Notes                                                                                                                    |
| :-- | :------------------------------------------------------------------------------ | :------- | :------ | :----------------------------------------------------------------------------------------------------------------------- |
| D-1 | [T28: Define Canonical Schema Interfaces](./p1.t28-define-schema-types.task.md) | Internal | ‚úÖ Done | The base types for the schema definition itself are a prerequisite for creating strongly-typed content schemas.          |
| D-2 | A Markdown Parser (e.g., `remark`)                                              | External | ‚úÖ Done | The schemas must validate the output of the chosen parser. We will assume a standard AST structure produced by `remark`. |

---

## 4 High-Level Design

### 4.2 Target Architecture

#### 4.2.1 Data Models

The Zod schemas will validate data structures representing parsed markdown content, while the applicability of these schemas is determined by definitions stored in the `ddd-schema-json` files.

```mermaid
erDiagram
    SCHEMA_DEFINITION {
        string name
        object applicability
    }
    FAMILY_ZOD_SCHEMA {
        object definition
    }
    SECTION_ZOD_SCHEMA {
        object definition
    }
    FIELD_ZOD_SCHEMA {
        object definition
    }
    PLAN_SCHEMA {
        object definition
    }
    TASK_SCHEMA {
        object definition
    }
    SECTION_CONTENT {
        string type
        any content
    }

    SCHEMA_DEFINITION ||--|| FAMILY_ZOD_SCHEMA : "guides composition of"
    SCHEMA_DEFINITION ||--|| SECTION_ZOD_SCHEMA : "guides composition of"
    SCHEMA_DEFINITION ||--|| FIELD_ZOD_SCHEMA : "guides composition of"

    FAMILY_ZOD_SCHEMA ||--|{ SECTION_SZOD_CHEMA : "contains"
    SECTION_ZOD_SCHEMA ||--|{ FIELD_ZOD_SCHEMA : "contains"

    FAMILY_ZOD_SCHEMA ||--o{ PLAN_SCHEMA : "composes"
    FAMILY_ZOD_SCHEMA ||--o{ TASK_SCHEMA : "composes"

    PLAN_SCHEMA ||--|| SECTION_CONTENT : "validates"
    TASK_SCHEMA ||--|| SECTION_CONTENT : "validates"
```

#### 4.2.2 Components

The architecture will be refactored to a more modular, decentralized model. The composition logic within the monolithic `SchemaFactory` will be distributed into family-specific factory functions. Each family schema module will be responsible for its own construction, using the `ddd-schema-json` rules to compose atomic field and section schemas into a final family-level schema. The central `SchemaFactory` will then act as a lightweight orchestrator, calling each family factory to assemble the complete document schema.

```mermaid
classDiagram
    direction LR

    class JsonDataSource {
        <<Data Source>>
        "src/schema/ddd-schema-json/*.json"
        +getSchemaDefinition()
    }

    class FieldLevelSchema {
        <<Atomic Schema>>
        "e.g., timestampSchema"
    }

    class SectionLevelSchema {
        <<Composite Schema>>
        "e.g., statusSchema"
    }

    class FamilySchemaFactory {
        <<Decentralized Factory>>
        "in [N]-family.schema.ts"
        +createFamilySchema(definition, docType)
    }

    class FamilyLevelSchema {
        <<Composed Output>>
        "e.g., metaGovernanceSchema"
    }

    class SchemaFactory {
        <<Orchestrator>>
        "schema-factory.ts"
        +createDocumentSchema(docType)
    }

    JsonDataSource --|> FamilySchemaFactory : "provides rules to"
    FieldLevelSchema --|> SectionLevelSchema : "is composed into"
    SectionLevelSchema --|> FamilySchemaFactory : "is composed by"
    FamilySchemaFactory --> FamilyLevelSchema : "produces"
    FamilyLevelSchema --|> SchemaFactory : "is assembled by"

```

#### 4.2.3 Data Flow

The data flow is now orchestrated by the central `SchemaFactory`, which delegates the complex composition work to each `FamilySchemaFactory`.

```mermaid
graph TD
    subgraph "Input Sources"
        A["JsonDataSource (ddd-schema-json/*.json)"]
        C["StaticZodSchemas (*.schema.ts)"]
    end

    subgraph "Orchestration"
        B{SchemaFactory}
    end

    subgraph "Decentralized Composition"
        F1["FamilySchemaFactory (Family 1)"]
        F2["FamilySchemaFactory (Family 2)"]
        F3["..."]
    end

    subgraph "Output"
        D["Document-specific Zod Schema (Plan or Task)"]
    end

    A -- "1: Load JSON Rules" --> B;
    B -- "2: For each family, call factory" --> F1;
    B -- "2: For each family, call factory" --> F2;
    B -- "2: For each family, call factory" --> F3;
    C -- "3: Consume static schemas" --> F1;
    C -- "3: Consume static schemas" --> F2;
    C -- "3: Consume static schemas" --> F3;
    F1 -- "4: Return composed family schema" --> B;
    F2 -- "4: Return composed family schema" --> B;
    F3 -- "4: Return composed family schema" --> B;
    B -- "5: Assemble final schema" --> D;
```

#### 4.2.4 Control Flow

The control flow is initiated by an external `Consumer` (e.g., a linter or test runner) that needs a document schema. The `SchemaFactory` orchestrates the creation process by sequentially calling each `FamilySchemaFactory`.

```mermaid
sequenceDiagram
    participant Consumer
    participant SchemaFactory
    participant FamilySchemaFactory_1 as Family 1 Factory
    participant FamilySchemaFactory_2 as Family 2 Factory
    participant FamilySchemaFactory_N as Family N Factory

    Consumer->>+SchemaFactory: createDocumentSchema(docType)
    SchemaFactory->>+FamilySchemaFactory_1: createFamilySchema(def, docType)
    FamilySchemaFactory_1-->>-SchemaFactory: Composed Family 1 Schema
    SchemaFactory->>+FamilySchemaFactory_2: createFamilySchema(def, docType)
    FamilySchemaFactory_2-->>-SchemaFactory: Composed Family 2 Schema
    SchemaFactory->>+FamilySchemaFactory_N: createFamilySchema(def, docType)
    FamilySchemaFactory_N-->>-SchemaFactory: Composed Family N Schema
    SchemaFactory-->>-Consumer: Final Document Schema
```

### 4.3 Tech Stack & Deployment

- **Language**: TypeScript
- **Schema Validation**: Zod
- **Testing**: Vitest
- **Deployment**: The schemas will be part of the `@livelifelively/ddd-tools` internal package, located in the `src/doc-parser/validation/` directory.

### 4.4 Non-Functional Requirements

#### 4.4.1 Performance

| ID      | Requirement                                                                   | Priority |
| :------ | :---------------------------------------------------------------------------- | :------- |
| PERF-01 | Schema validation should be fast enough for interactive use (e.g., git-hook). | üü• High  |

#### 4.4.2 Security

| ID     | Requirement                                                          | Priority |
| :----- | :------------------------------------------------------------------- | :------- |
| SEC-01 | Schemas must not execute any untrusted code from the parsed content. | üü• High  |

---

## 5 Maintenance and Monitoring

### 5.2 Target Maintenance and Monitoring

#### 5.2.1 Error Handling

| Error Type                       | Trigger                                                                | Action                                | Consumer Feedback                                                                      |
| :------------------------------- | :--------------------------------------------------------------------- | :------------------------------------ | :------------------------------------------------------------------------------------- |
| **Schema Validation Failure**    | A consumer calls `schema.parse()` with a non-compliant content object. | Zod throws a `ZodError`.              | The `ZodError` object contains detailed information about the validation failure.      |
| **Schema Definition Load Error** | The `SchemaFactory` cannot find or parse a `ddd-schema-json` file.     | The factory function throws an Error. | A descriptive error message, e.g., "Failed to load schema definition for family 1".    |
| **Schema Import Failure**        | A consumer attempts to import a non-existent schema from the library.  | Runtime throws an error.              | Standard module-not-found error from the runtime environment (e.g., Node.js, bundler). |

#### 5.2.2 Logging & Monitoring

- **Logging**: While the library itself won't have a dedicated logger, the `SchemaFactory` will use `console.warn` for non-blocking issues (e.g., a missing schema for an optional family) and will throw descriptive errors for critical issues. It is the consumer's responsibility to catch and log these appropriately.
- **Monitoring**: Not applicable. The consuming tool is responsible for any monitoring related to schema validation.

---

## 6 Implementation Guidance

### 6.1 Implementation Log / Steps

- Latest updates

  - Converted families 6‚Äì8 to the functions-only export pattern; removed static schema/type exports; added `create...Schema` and `get...Schema` where applicable; all family tests green.
  - Refactored tests to access section schemas via `create...Schema('plan'|'task').shape` with local `planShape`/`taskShape` where useful.
  - Fixed Family 3 array element validation to avoid `.element` by validating via the array schema (wrap the item in an array).
  - Family 5: added `id` to error handling rows; standardized `loggingMonitoring` to table shape with optional `notes`; used table schemas for current/target sections.
  - Index integration: exports only factory functions and combined `getTaskSchema`/`getPlanSchema`; `index.test.ts` updated and green.
  - Integration tests: added negative task case (multiple structural errors) and positive plan case; removed debug logging; suite green.

- [x] Create the main directory `src/doc-parser/validation/`.
- [x] Create the test directory `src/doc-parser/validation/__tests__/`.
  - [x] **Family 1: Meta & Governance** ‚úÖ
  - [x] Create `src/doc-parser/validation/1-meta-governance.schema.ts`.
  - [x] Create `src/doc-parser/validation/__tests__/1-meta-governance.schema.test.ts`.
  - [x] Implement and test schemas for all sections in Family 1.
  - [x] **Family 2: Business & Scope**
  - [x] Create `src/doc-parser/validation/2-business-scope.schema.ts`.
  - [x] Create `src/doc-parser/validation/__tests__/2-business-scope.schema.test.ts`.
  - [x] Implement and test schemas for all sections in Family 2.
    - [x] **Family 3: Planning & Decomposition**
  - [x] Create `src/doc-parser/validation/3-planning-decomposition.schema.ts`.
  - [x] Create `src/doc-parser/validation/__tests__/3-planning-decomposition.schema.test.ts`.
  - [x] Implement and test schemas for all sections in Family 3.
  - [x] **Family 4: High-Level Design**
  - [x] Create `src/doc-parser/validation/4-high-level-design.schema.ts`.
  - [x] Create `src/doc-parser/validation/__tests__/4-high-level-design.schema.test.ts`.
  - [x] Implement and test schemas for all sections in Family 4.
- [x] **Family 5: Maintenance and Monitoring** ‚úÖ
  - [x] Create `src/doc-parser/validation/5-maintenance-monitoring.schema.ts`.
  - [x] Create `src/doc-parser/validation/__tests__/5-maintenance-monitoring.schema.test.ts`.
  - [x] Implement and test schemas for all sections in Family 5.
- [x] **Family 6: Implementation Guidance** ‚úÖ
  - [x] Create `src/doc-parser/validation/6-implementation-guidance.schema.ts`.
  - [x] Create `src/doc-parser/validation/__tests__/6-implementation-guidance.schema.test.ts`.
  - [x] Implement and test schemas for all sections in Family 6.
- [x] **Family 7: Quality & Operations** ‚úÖ
  - [x] Create `src/doc-parser/validation/7-quality-operations.schema.ts`.
  - [x] Create `src/doc-parser/validation/__tests__/7-quality-operations.schema.test.ts`.
  - [x] Implement and test schemas for all sections in Family 7.
- [x] **Family 8: Reference** ‚úÖ
  - [x] Create `src/doc-parser/validation/8-reference.schema.ts`.
  - [x] Create `src/doc-parser/validation/__tests__/8-reference.schema.test.ts`.
  - [x] Implement and test schemas for all sections in Family 8.
- [x] **Integration Testing**
  - [x] Create a directory `src/doc-parser/validation/__tests__/mocks/` for mock markdown files.
  - [x] Create at least one valid and one invalid mock `*.task.md` file.
  - [x] Create the integration test file `src/doc-parser/validation/__tests__/integration.test.ts`.
  - [x] Implement tests that parse the mock files and validate their content against the schemas.
- [x] **Finalization**
  - [x] Create the barrel file `src/doc-parser/validation/index.ts` to export all family-level schemas.
  - [x] Create a test file `src/doc-parser/validation/__tests__/index.test.ts` to ensure all exports are present.
- [x] **Phase 1: Create Shared Utilities**
  - [x] Create `src/doc-parser/validation/shared.schema.ts`.
  - [x] Add a `DocumentType` enum (`'plan' | 'task'`).
  - [x] Add helper functions to read and process the `applicability` rules from the `ddd-schema-json` files.
  - [x] Make family definitions configurable with default values.
  - [x] Add detailed applicability information (required/optional/omitted) instead of just boolean.
- [x] **Phase 2: Refactor to Decentralized Factories**
  - [x] **Create Shared Composition Utilities:**
    - [x] In `shared.schema.ts`, create generic helper functions (e.g., `applyApplicability(schema, rules, docType)`) to handle the common Zod `.pick()`, `.omit()`, and `.optional()` logic based on applicability rules.
  - [x] **Implement Family-Specific Factories (All Families 1‚Äì8 complete)**

---

## 7 Quality & Operations

### 7.1 Testing Strategy / Requirements

| AC ID | DoD Link | Scenario                                                                                                                               | Test Type   | Test File                                           |
| :---- | :------- | :------------------------------------------------------------------------------------------------------------------------------------- | :---------- | :-------------------------------------------------- |
| AC-1  | DoD-2    | Unit test for `MetaGovernanceFamilySchema` (valid and invalid Status)                                                                  | Unit        | `__tests__/1-meta-governance.schema.test.ts`        |
| AC-2  | DoD-3    | Unit test for `BusinessScopeFamilySchema` (valid and invalid DoD table)                                                                | Unit        | `__tests__/2-business-scope.schema.test.ts`         |
| AC-3  | DoD-3    | Unit test for `PlanningDecompositionFamilySchema` (valid/invalid Dep table)                                                            | Unit        | `__tests__/3-planning-decomposition.schema.test.ts` |
| AC-4  | DoD-4, 6 | Integration test with a fully valid mock `task.md` using the `TaskSchema`                                                              | Integration | `__tests__/integration.test.ts`                     |
| AC-5  | DoD-4, 6 | Integration test with a mock `task.md` containing multiple errors using the `TaskSchema`                                               | Integration | `__tests__/integration.test.ts`                     |
| AC-6  | DoD-1, 5 | Test that all family schemas and composite schemas (`TaskSchema`, `PlanSchema`) are exported from the main index.                      | Unit        | `__tests__/index.test.ts`                           |
| AC-7  | DoD-6    | Unit test for `schema-factory` to ensure it correctly composes a **task-specific schema**, respecting section and field applicability. | Unit        | `__tests__/schema-factory.test.ts`                  |
| AC-8  | DoD-6    | Unit test for `schema-factory` to ensure it correctly composes a **plan-specific schema**, respecting section and field applicability. | Unit        | `__tests__/schema-factory.test.ts`                  |
| AC-9  | DoD-4, 6 | Integration test with a fully valid mock `plan.md` using the `PlanSchema` factory function.                                            | Integration | `__tests__/integration.test.ts`                     |
| AC-10 | DoD-6    | Unit test for `createFamilySchema` in each family module to verify correct composition for both 'plan' and 'task' types.               | Unit        | `__tests__/[N]-<family-name>.schema.test.ts`        |
| AC-11 | DoD-6    | Unit test for the central `SchemaFactory` orchestrator to ensure it correctly calls all family factories.                              | Unit        | `__tests__/schema-factory.test.ts`                  |

### 7.5 Local Test Commands

```bash
# Run all validation schema tests (unit and integration) and view coverage
npm test -- --coverage src/doc-parser/validation/
```

---

## 8 Reference

### 8.1 Appendices/Glossary

- **Zod**: The schema validation library used to define the content structure rules.
- **AST (Abstract Syntax Tree)**: The tree representation of the parsed markdown content that the schemas will validate.
- **Consumer**: Any tool or script that imports and uses this schema library for validation (e.g., a linter, a git-hook script).
